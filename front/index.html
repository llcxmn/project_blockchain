<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance Logger (Lokal)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin:24px; max-width:900px }
    h1 { margin:0 0 6px }
    .muted { color:#666; font-size:12px }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0 }
    label { display:block; font-weight:600; margin:8px 0 4px }
    input, select, button { padding:10px; border-radius:8px; border:1px solid #ccc; width:100% }
    button { cursor:pointer }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px }
    table { width:100%; border-collapse:collapse; margin-top:12px }
    th, td { border:1px solid #eee; padding:10px; text-align:left; font-size:14px }
    th { background:#fafafa }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #ddd; font-size:12px }
    .row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
  </style>
</head>
<body>
  <h1>Attendance Logger (Lokal)</h1>
  <p class="muted">Buka via http://127.0.0.1:8080 ‚Ä¢ Hardhat node (ChainId 31337) ‚Ä¢ MetaMask jaringan localhost:8545.</p>

  <div class="card">
    <div class="row">
      <div>
        <label>Alamat Kontrak</label>
        <input id="contractAddress" placeholder="0x... (alamat hasil deploy TERBARU)" />
      </div>
      <div>
        <label>Info</label>
        <input value="RPC: http://127.0.0.1:8545 | ChainId: 31337" readonly />
      </div>
    </div>
    <div class="row-3" style="margin-top:8px">
      <button id="btnConnect">üîå Connect Wallet</button>
      <button id="btnChoose">üîÑ Pilih Ulang Akun</button>
      <button id="btnLoad">üîÑ Cek Total</button>
    </div>
    <p id="txStatus" class="muted"></p>
  </div>

  <div class="card">
    <h3>Catat Kehadiran</h3>
    <label>Nama</label>
    <input id="nama" placeholder="mis. Budi" />
    <label>Status</label>
    <select id="status">
      <option value="0">Hadir</option>
      <option value="1">TidakHadir</option>
    </select>
    <div class="row" style="margin-top:8px">
      <button id="btnSubmit">üìù Simpan</button>
      <button id="btnBatch">üìö Ambil Batch (1..20)</button>
    </div>
  </div>

  <div class="card">
    <h3>Riwayat</h3>
    <table>
      <thead><tr><th>ID</th><th>Nama</th><th>Waktu</th><th>Status</th><th>Pencatat</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <!-- Ethers UMD (global window.ethers) -->
  <script src="/vendor/ethers.umd.min.js"></script>

  <script>
    if (!window.ethers) alert("Ethers gagal dimuat. Pastikan /vendor/ethers.umd.min.js ada & server http berjalan.");

    // ===== Konstanta & util =====
    const ABI = [
      {"inputs":[{"internalType":"string","name":"_nama","type":"string"},{"internalType":"uint8","name":"_status","type":"uint8"}],"name":"logAttendance","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"startId","type":"uint256"},{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getBatch","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"nama","type":"string"},{"internalType":"uint256","name":"waktu","type":"uint256"},{"internalType":"uint8","name":"status","type":"uint8"},{"internalType":"address","name":"pencatat","type":"address"}],"internalType":"struct AttendanceLogger.Record[]","name":"out","type":"tuple[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"total","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"nama","type":"string"},{"indexed":false,"internalType":"uint256","name":"waktu","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"status","type":"uint8"},{"indexed":true,"internalType":"address","name":"pencatat","type":"address"}],"name":"AttendanceLogged","type":"event"}
    ];
    const RPC_URL = "http://127.0.0.1:8545";
    const isAddr = (a) => /^0x[0-9a-fA-F]{40}$/.test(a);
    const $ = (id) => document.getElementById(id);
    const fmt = (t) => new Date(Number(t)*1000).toLocaleString();
    const msg = (e) => e?.shortMessage || e?.info?.error?.message || e?.data?.message || e?.message || String(e);

    // ===== Providers & globals (untuk debugging di Console) =====
    window.rpcProv = new ethers.JsonRpcProvider(RPC_URL); // READ langsung ke node lokal
    window.browserProv = null; // MetaMask
    window.signer = null;
    window.contract = null;
    window.contractAddr = null;

    function getInjectedProvider() {
      const eth = window.ethereum;
      if (!eth) return null;
      if (Array.isArray(eth.providers)) {
        const mm = eth.providers.find(p => p.isMetaMask);
        return mm || eth.providers[0];
      }
      return eth;
    }

    async function ensureCode(addr) {
      if (!isAddr(addr)) throw new Error("Alamat kontrak tidak valid (0x + 40 hex).");
      const code = await window.rpcProv.getCode(addr);
      if (!code || code === "0x") throw new Error("Tidak ada bytecode di alamat ini. Deploy ulang & pakai alamat TERBARU.");
    }

    function renderRows(list){
      const tbody = $("rows"); tbody.innerHTML = "";
      for (const r of list) {
        const st = Number(r.status) === 0 ? '<span class="pill">Hadir</span>' : '<span class="pill">TidakHadir</span>';
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.id}</td><td>${r.nama}</td><td>${fmt(r.waktu)}</td><td>${st}</td><td class="muted">${r.pencatat}</td>`;
        tbody.appendChild(tr);
      }
    }

    async function rebindSignerAndContract() {
      if (!window.browserProv) return;
      window.signer = await window.browserProv.getSigner();
      const addr = window.contract?.target || window.contractAddr || $("contractAddress").value.trim();
      if (addr && isAddr(addr)) {
        window.contractAddr = addr;
        window.contract = new ethers.Contract(addr, ABI, window.signer);
      }
      const nw = await window.browserProv.getNetwork();
      $("txStatus").textContent = `Connected: ${await window.signer.getAddress()} | chainId ${nw.chainId}`;
    }

    // ===== Actions =====
    async function connect() {
      const injected = getInjectedProvider();
      if (!injected) return alert("MetaMask tidak terdeteksi.");
      window.browserProv = new ethers.BrowserProvider(injected);
      await window.browserProv.send("eth_requestAccounts", []); // pop-up Connect

      window.contractAddr = $("contractAddress").value.trim();
      await ensureCode(window.contractAddr);      // pastikan alamat valid di node lokal
      await rebindSignerAndContract();            // init signer & kontrak
    }

    async function chooseAccountAgain() {
      if (!window.ethereum) return alert("MetaMask tidak terdeteksi.");
      await window.ethereum.request({ method: "wallet_requestPermissions", params: [{ eth_accounts: {} }] });
      await window.browserProv?.send("eth_requestAccounts", []);
      await rebindSignerAndContract();            // pakai akun yang baru dipilih
    }

    async function checkTotal() {
      try {
        const addr = $("contractAddress").value.trim();
        await ensureCode(addr);
        const read = new ethers.Contract(addr, ABI, window.rpcProv); // READ via RPC
        const tot = await read.total();
        $("txStatus").textContent = `Total record: ${tot.toString()}`;
      } catch (e) {
        $("txStatus").textContent = "Gagal cek total: " + msg(e);
      }
    }

    async function submit() {
      try {
        if (!window.contract) return alert("Connect Wallet dulu.");
        await rebindSignerAndContract();          // pastikan signer = akun aktif
        const nama = $("nama").value.trim();
        const status = Number($("status").value);
        if (!nama) return alert("Nama wajib diisi.");

        $("txStatus").textContent = "Mengirim transaksi...";
        const tx = await window.contract.logAttendance(nama, status); // WRITE via MetaMask
        $("txStatus").textContent = "TX: " + tx.hash + " (waiting...)";
        const rc = await tx.wait();
        $("txStatus").textContent = "Mined in block " + rc.blockNumber;
      } catch (e) {
        $("txStatus").textContent = "Gagal: " + msg(e);
      }
    }

    async function loadBatch() {
      try {
        if (!window.contract) return alert("Connect Wallet dulu.");
        await ensureCode(window.contract.target);
        const read = new ethers.Contract(window.contract.target, ABI, window.rpcProv); // READ via RPC
        const data = await read.getBatch(1, 20);
        renderRows(data);
        $("txStatus").textContent = "Muat batch OK.";
      } catch (e) {
        $("txStatus").textContent = "Gagal muat: " + msg(e);
      }
    }

    // ===== Wallet event listeners =====
    if (window.ethereum) {
      window.ethereum.on?.("accountsChanged", async () => { try { await rebindSignerAndContract(); } catch {} });
      window.ethereum.on?.("chainChanged", () => location.reload());
    }

    // ===== Bind tombol =====
    $("btnConnect").onclick = connect;
    $("btnChoose").onclick = chooseAccountAgain;
    $("btnLoad").onclick = checkTotal;
    $("btnSubmit").onclick = submit;
    $("btnBatch").onclick = loadBatch;
  </script>
</body>
</html>
